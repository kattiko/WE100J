<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WE100J</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        .target-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .target-image {
            max-width: 300px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin: 20px auto;
            display: block;
        }

        .progress-bar {
            background: #f0f0f0;
            height: 30px;
            border-radius: 15px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
        }

        .selection-info {
            text-align: center;
            margin: 20px 0;
            font-size: 1.1em;
            color: #333;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .image-choice {
            cursor: pointer;
            border: 3px solid transparent;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }

        .image-choice:hover {
            transform: scale(1.05);
            border-color: #667eea;
        }

        .image-choice.selected {
            border-color: #764ba2;
            box-shadow: 0 0 20px rgba(118, 75, 162, 0.5);
        }

        .image-choice img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 20px auto;
            font-weight: bold;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .results-section h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .winning-series {
            background: #d4edda;
            border-left-color: #28a745;
            font-weight: bold;
        }

        .config-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        .config-section input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #dc3545;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .statistics-section {
            background: #f0f8ff;
            padding: 30px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #667eea;
        }

        .statistics-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            margin-top: 20px;
        }

        .statistics-section h3:first-child {
            margin-top: 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .stats-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stats-card .number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stats-card .label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .stats-card .deviation {
            color: #764ba2;
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 5px;
        }

        .duplicate-combo {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 4px solid #ff9800;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .duplicate-combo.high-frequency {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .combo-numbers {
            font-family: monospace;
            font-weight: bold;
        }

        .combo-count {
            background: #ff9800;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .duplicate-combo.high-frequency .combo-count {
            background: #f44336;
        }

        .toggle-stats-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1em;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 15px auto;
            display: block;
            font-weight: bold;
        }

        .toggle-stats-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #667eea;
        }

        .filter-section h3 {
            margin-top: 0;
            color: #667eea;
        }

        .filter-section label {
            display: block;
            margin-bottom: 10px;
            color: #666;
            font-weight: 500;
        }

        .filter-section input[type="date"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            margin-bottom: 15px;
            width: 100%;
            max-width: 300px;
        }

        .filter-section .btn {
            margin: 5px 10px 5px 0;
            padding: 10px 25px;
            font-size: 0.95em;
            display: inline-block;
        }

        .filter-info {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 5px;
            margin-top: 15px;
            color: #1976d2;
            border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WE100J</h1>
        <p class="subtitle"> </p>

        <!-- Configuration Section -->
        <div id="configSection" class="config-section">
            <h3>‚öôÔ∏è GitHub Configuration</h3>
            <p>Enter your GitHub repository details to save selections:</p>
            <input type="text" id="repoOwner" placeholder="Repository Owner (e.g., username)">
            <input type="text" id="repoName" placeholder="Repository Name (e.g., lottery-game)">
            <input type="password" id="githubToken" placeholder="GitHub Personal Access Token (optional for public repos)">
            <small>Note: Token is only needed for private repositories. Create one at <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings</a> with 'repo' scope.</small>
            <button class="btn" onclick="app.saveConfig()">Save Configuration</button>
        </div>

        <!-- Target Section -->
        <div id="targetSection" class="target-section hidden">
            <h2>Focus on this target image</h2>
            <img src="target.png" alt="Target" class="target-image" id="targetImage">
            <p>Clear your mind and focus on the image above. When ready, click below to begin.</p>
            <button class="btn" onclick="app.startSelection()">Click When Ready</button>
        </div>

        <!-- Preparation Section -->
        <div id="preparationSection" class="target-section hidden">
            <h2>Prepare for Selection</h2>
            <p style="font-size: 1.2em; margin: 30px 0;">Close your eyes and focus on the target image.</p>
            <p style="color: #666; margin-bottom: 30px;">When you feel ready, proceed to make your selection.</p>
            <button class="btn" onclick="app.proceedToSelection()">Proceed to Selection</button>
        </div>

        <!-- Selection Section -->
        <div id="selectionSection" class="hidden">
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar">0/7</div>
            </div>
            
            <div class="selection-info" id="selectionInfo">
                Select an image
            </div>

            <div class="image-grid" id="imageGrid"></div>

            <button class="btn" id="proceedBtn" onclick="app.proceedToNext()" disabled>Proceed to Next Selection</button>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            <div class="loading" id="loadingResults">
                <div class="spinner"></div>
                <p>Analyzing your selection...</p>
            </div>
            <div id="resultsContent" class="hidden"></div>
            <button class="btn" onclick="app.reset()">Start New Game</button>
        </div>
    </div>

    <script>
        const app = {
            config: {
                owner: '',
                repo: '',
                token: ''
            },
            gameState: {
                selectedNumbers: [],
                currentPool: [],
                currentSelection: null,
                selectionStep: 0,
                usedImages: [],
                poolType: 'main',
                pendingGroups: null,
                selectionSchedule: [],
                currentScheduleIndex: 0
            },
            availableImages: Array.from({length: 555}, (_, i) => `choice${i + 1}.jpg`),
            analysisData: null,
            allIssues: [],
            filterDate: null,

            init() {
                this.loadConfig();
                if (this.config.owner && this.config.repo) {
                    document.getElementById('configSection').classList.add('hidden');
                    document.getElementById('targetSection').classList.remove('hidden');
                }
            },

            saveConfig() {
                this.config.owner = document.getElementById('repoOwner').value.trim();
                this.config.repo = document.getElementById('repoName').value.trim();
                this.config.token = document.getElementById('githubToken').value.trim();
                
                if (!this.config.owner || !this.config.repo) {
                    alert('Please enter both repository owner and name');
                    return;
                }

                localStorage.setItem('rvlConfig', JSON.stringify(this.config));
                document.getElementById('configSection').classList.add('hidden');
                document.getElementById('targetSection').classList.remove('hidden');
            },

            loadConfig() {
                const saved = localStorage.getItem('rvlConfig');
                if (saved) {
                    this.config = JSON.parse(saved);
                    document.getElementById('repoOwner').value = this.config.owner;
                    document.getElementById('repoName').value = this.config.repo;
                }
            },

            createSelectionSchedule() {
                // Create array with 5 'main' and 2 'bonus'
                const schedule = [
                    'main', 'main', 'main', 'main', 'main',
                    'bonus', 'bonus'
                ];
                
                // Shuffle using Fisher-Yates algorithm
                for (let i = schedule.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [schedule[i], schedule[j]] = [schedule[j], schedule[i]];
                }
                
                return schedule;
            },

            startSelection() {
                document.getElementById('targetSection').classList.add('hidden');
                this.gameState = {
                    selectedNumbers: [],
                    currentPool: [],
                    currentSelection: null,
                    selectionStep: 0,
                    usedImages: [],
                    poolType: 'main',
                    pendingGroups: null,
                    selectionSchedule: this.createSelectionSchedule(),
                    currentScheduleIndex: 0
                };
                this.startNewNumber();
            },

            showPreparation() {
                document.getElementById('selectionSection').classList.add('hidden');
                document.getElementById('preparationSection').classList.remove('hidden');
            },

            proceedToSelection() {
                document.getElementById('preparationSection').classList.add('hidden');
                document.getElementById('selectionSection').classList.remove('hidden');
                
                // Display the pending groups that were prepared
                if (this.gameState.pendingGroups) {
                    this.displayImageChoices(this.gameState.pendingGroups);
                    this.gameState.pendingGroups = null;
                } else {
                    // Fallback in case something went wrong
                    this.startNewNumber();
                }
            },

            startNewNumber() {
                const poolType = this.gameState.selectionSchedule[this.gameState.currentScheduleIndex];
                
                if (poolType === 'main') {
                    this.gameState.currentPool = Array.from({length: 50}, (_, i) => i + 1);
                    this.gameState.poolType = 'main';
                } else {
                    this.gameState.currentPool = Array.from({length: 12}, (_, i) => i + 1);
                    this.gameState.poolType = 'bonus';
                }
                
                this.gameState.selectionStep = 0;
                this.showChoices();
            },

            showChoices() {
                const pool = this.gameState.currentPool;
                const numbersSelected = this.gameState.selectedNumbers.length;
                
                document.getElementById('progressBar').style.width = `${(numbersSelected / 7) * 100}%`;
                document.getElementById('progressBar').textContent = `${numbersSelected}/7`;
                
                const poolName = this.gameState.poolType === 'main' ? '1-50' : '1-12';
                document.getElementById('selectionInfo').textContent = 
                    `Selecting number ${numbersSelected + 1} of 7 (Pool: ${poolName})`;
                
                if (pool.length === 1) {
                    this.gameState.selectedNumbers.push({
                        number: pool[0],
                        poolType: this.gameState.poolType
                    });
                    this.gameState.currentScheduleIndex++;
                    
                    if (this.gameState.selectedNumbers.length === 7) {
                        this.completeSelection();
                    } else {
                        // Start next number
                        this.startNewNumber();
                    }
                    return;
                }
                
                // Create groups and save them, then show preparation
                const numGroups = Math.min(5, pool.length);
                const groups = this.divideIntoGroups(pool, numGroups);
                this.gameState.pendingGroups = groups;
                
                // Show preparation before each image selection
                this.showPreparation();
            },

            divideIntoGroups(pool, numGroups) {
                // FIXED: Proper Fisher-Yates shuffle instead of biased sort
                const shuffled = [...pool];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                
                const groupSize = Math.ceil(shuffled.length / numGroups);
                const groups = [];
                
                for (let i = 0; i < numGroups; i++) {
                    const start = i * groupSize;
                    const end = Math.min(start + groupSize, shuffled.length);
                    if (start < shuffled.length) {
                        groups.push(shuffled.slice(start, end));
                    }
                }
                
                return groups.filter(g => g.length > 0);
            },

            displayImageChoices(groups) {
                const grid = document.getElementById('imageGrid');
                grid.innerHTML = '';
                this.gameState.currentSelection = null;
                document.getElementById('proceedBtn').disabled = true;
                
                groups.forEach((group, index) => {
                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'image-choice';
                    imageDiv.dataset.group = JSON.stringify(group);
                    
                    const img = document.createElement('img');
                    img.src = this.getRandomImage();
                    img.alt = `Choice ${index + 1}`;
                    
                    imageDiv.appendChild(img);
                    imageDiv.onclick = () => this.selectImage(imageDiv, group);
                    grid.appendChild(imageDiv);
                });
            },

            getRandomImage() {
                const available = this.availableImages.filter(img => !this.gameState.usedImages.includes(img));
                if (available.length === 0) {
                    this.gameState.usedImages = [];
                    return this.availableImages[Math.floor(Math.random() * this.availableImages.length)];
                }
                const selected = available[Math.floor(Math.random() * available.length)];
                this.gameState.usedImages.push(selected);
                return selected;
            },

            selectImage(element, group) {
                document.querySelectorAll('.image-choice').forEach(el => {
                    el.classList.remove('selected');
                });
                
                element.classList.add('selected');
                this.gameState.currentSelection = group;
                document.getElementById('proceedBtn').disabled = false;
            },

            proceedToNext() {
                if (!this.gameState.currentSelection) return;
                
                this.gameState.currentPool = this.gameState.currentSelection;
                this.gameState.selectionStep++;
                this.showChoices();
            },

            async completeSelection() {
                document.getElementById('selectionSection').classList.add('hidden');
                document.getElementById('preparationSection').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');
                document.getElementById('loadingResults').classList.remove('hidden');
                
                try {
                    await this.submitToGitHub();
                    const analysis = await this.analyzeResults();
                    this.analysisData = analysis;
                    this.displayResults(analysis);
                } catch (error) {
                    console.error('Error:', error);
                    document.getElementById('resultsContent').innerHTML = 
                        `<div class="error"><strong>‚ùå Error</strong><br><br>${error.message}<br><br>Your selection was not saved. Please check your GitHub configuration and try again.</div>`;
                } finally {
                    document.getElementById('loadingResults').classList.add('hidden');
                    document.getElementById('resultsContent').classList.remove('hidden');
                }
            },

            async submitToGitHub() {
                const mainNumbers = this.gameState.selectedNumbers
                    .filter(item => item.poolType === 'main')
                    .map(item => item.number)
                    .sort((a, b) => a - b);
                
                const bonusNumbers = this.gameState.selectedNumbers
                    .filter(item => item.poolType === 'bonus')
                    .map(item => item.number)
                    .sort((a, b) => a - b);
                
                const seriesString = `${mainNumbers.join('-')} + ${bonusNumbers.join('-')}`;
                
                const issueData = {
                    title: `Selection: ${seriesString}`,
                    body: `Main Numbers: ${mainNumbers.join(', ')}\nBonus Numbers: ${bonusNumbers.join(', ')}\nTimestamp: ${new Date().toISOString()}`,
                    labels: ['lottery-selection']
                };
                
                const headers = {
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                };
                
                if (this.config.token) {
                    headers['Authorization'] = `token ${this.config.token}`;
                }
                
                const response = await fetch(
                    `https://api.github.com/repos/${this.config.owner}/${this.config.repo}/issues`,
                    {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(issueData)
                    }
                );
                
                if (!response.ok) {
                    let errorMessage = `GitHub API error (${response.status}): ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.message) {
                            errorMessage += `\n${errorData.message}`;
                        }
                        if (errorData.documentation_url) {
                            errorMessage += `\nSee: ${errorData.documentation_url}`;
                        }
                    } catch (e) {
                        // Could not parse error response
                    }
                    
                    if (response.status === 404) {
                        errorMessage += '\n\nTip: Check that your repository owner and name are correct.';
                    } else if (response.status === 401) {
                        errorMessage += '\n\nTip: Your token may be invalid or expired. Try generating a new one.';
                    } else if (response.status === 403) {
                        errorMessage += '\n\nTip: Make sure your token has "repo" permissions or the repository is public.';
                    }
                    
                    throw new Error(errorMessage);
                }
                
                return await response.json();
            },

            async analyzeResults() {
                const headers = {
                    'Accept': 'application/vnd.github.v3+json'
                };
                
                if (this.config.token) {
                    headers['Authorization'] = `token ${this.config.token}`;
                }
                
                const response = await fetch(
                    `https://api.github.com/repos/${this.config.owner}/${this.config.repo}/issues?labels=lottery-selection&state=all&per_page=100`,
                    { headers }
                );
                
                if (!response.ok) {
                    let errorMessage = `Failed to fetch issues (${response.status}): ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.message) {
                            errorMessage += `\n${errorData.message}`;
                        }
                    } catch (e) {
                        // Could not parse error response
                    }
                    throw new Error(errorMessage);
                }
                
                const issues = await response.json();
                this.allIssues = issues;
                
                return this.processAnalysis(issues);
            },

            processAnalysis(issues) {
                const allSelections = [];
                const numberFrequency = { main: {}, bonus: {} };
                const comboFrequency = {};
                
                for (let i = 1; i <= 50; i++) numberFrequency.main[i] = 0;
                for (let i = 1; i <= 12; i++) numberFrequency.bonus[i] = 0;
                
                // Filter issues by date if filter is active
                const filteredIssues = this.filterDate 
                    ? issues.filter(issue => new Date(issue.created_at) >= new Date(this.filterDate))
                    : issues;
                
                filteredIssues.forEach(issue => {
                    const match = issue.title.match(/Selection: (.+)/);
                    if (match) {
                        const [mainPart, bonusPart] = match[1].split(' + ');
                        const mainNumbers = mainPart.split('-').map(Number);
                        const bonusNumbers = bonusPart.split('-').map(Number);
                        
                        allSelections.push({ main: mainNumbers, bonus: bonusNumbers });
                        
                        mainNumbers.forEach(num => numberFrequency.main[num]++);
                        bonusNumbers.forEach(num => numberFrequency.bonus[num]++);
                        
                        const comboKey = `${mainNumbers.join('-')} + ${bonusNumbers.join('-')}`;
                        comboFrequency[comboKey] = (comboFrequency[comboKey] || 0) + 1;
                    }
                });
                
                const totalSelections = allSelections.length;
                const expectedMainFreq = totalSelections * (5 / 50);
                const expectedBonusFreq = totalSelections * (2 / 12);
                
                const mainNumbers = this.gameState.selectedNumbers
                    .filter(item => item.poolType === 'main')
                    .map(item => item.number)
                    .sort((a, b) => a - b);
                
                const bonusNumbers = this.gameState.selectedNumbers
                    .filter(item => item.poolType === 'bonus')
                    .map(item => item.number)
                    .sort((a, b) => a - b);
                
                const currentSelection = {
                    main: mainNumbers,
                    bonus: bonusNumbers
                };
                
                const mainDeviations = [];
                for (let i = 1; i <= 50; i++) {
                    const actual = numberFrequency.main[i];
                    const expected = expectedMainFreq;
                    const deviation = expected > 0 ? ((actual - expected) / expected) * 100 : 0;
                    mainDeviations.push({ number: i, frequency: actual, deviation });
                }
                mainDeviations.sort((a, b) => b.deviation - a.deviation);
                
                const bonusDeviations = [];
                for (let i = 1; i <= 12; i++) {
                    const actual = numberFrequency.bonus[i];
                    const expected = expectedBonusFreq;
                    const deviation = expected > 0 ? ((actual - expected) / expected) * 100 : 0;
                    bonusDeviations.push({ number: i, frequency: actual, deviation });
                }
                bonusDeviations.sort((a, b) => b.deviation - a.deviation);
                
                const duplicateCombos = Object.entries(comboFrequency)
                    .filter(([combo, count]) => count > 1)
                    .map(([combo, count]) => ({ combo, count }))
                    .sort((a, b) => b.count - a.count);
                
                const analysis = {
                    totalSelections,
                    aboveAverageCount: 0,
                    duplicates: [],
                    currentSelection,
                    numberFrequency,
                    expectedMainFreq,
                    expectedBonusFreq,
                    topMainNumbers: mainDeviations.slice(0, 5),
                    topBonusNumbers: bonusDeviations.slice(0, 2),
                    bottomMainNumbers: mainDeviations.slice(-5).reverse(),
                    bottomBonusNumbers: bonusDeviations.slice(-2).reverse(),
                    duplicateCombos
                };
                
                currentSelection.main.forEach(num => {
                    if (numberFrequency.main[num] > expectedMainFreq * 1.2) {
                        analysis.aboveAverageCount++;
                    }
                });
                
                currentSelection.bonus.forEach(num => {
                    if (numberFrequency.bonus[num] > expectedBonusFreq * 1.2) {
                        analysis.aboveAverageCount++;
                    }
                });
                
                allSelections.forEach((selection, index) => {
                    const matchesMain = JSON.stringify(selection.main.sort()) === 
                                       JSON.stringify(currentSelection.main.sort());
                    const matchesBonus = JSON.stringify(selection.bonus.sort()) === 
                                        JSON.stringify(currentSelection.bonus.sort());
                    
                    if (matchesMain && matchesBonus && index < allSelections.length - 1) {
                        let aboveAvg = 0;
                        selection.main.forEach(num => {
                            if (numberFrequency.main[num] > expectedMainFreq * 1.2) aboveAvg++;
                        });
                        selection.bonus.forEach(num => {
                            if (numberFrequency.bonus[num] > expectedBonusFreq * 1.2) aboveAvg++;
                        });
                        
                        analysis.duplicates.push({
                            selection,
                            aboveAverageCount: aboveAvg,
                            allAboveAverage: aboveAvg === 7
                        });
                    }
                });
                
                return analysis;
            },

            displayResults(analysis) {
                const content = document.getElementById('resultsContent');
                let html = '<div class="results-section">';
                html += '<h2>üéØ Your Selection Results</h2>';
                
                const allAboveAverage = analysis.aboveAverageCount === 7;
                
                if (allAboveAverage) {
                    html += '<div class="stat-item winning-series">';
                    html += '<strong>üåü REMARKABLE! All 7 of your numbers are above statistical average!</strong><br>';
                    html += '<strong>Your Numbers:</strong><br>';
                    html += `Main: ${analysis.currentSelection.main.join(', ')}<br>`;
                    html += `Bonus: ${analysis.currentSelection.bonus.join(', ')}`;
                    html += '</div>';
                }
                
                html += '<div class="stat-item">';
                html += `<strong>Total Selections in Database:</strong> ${analysis.totalSelections}`;
                html += '</div>';
                
                html += '<div class="stat-item">';
                html += `<strong>Numbers Above 20% Statistical Average:</strong> ${analysis.aboveAverageCount} out of 7`;
                html += '</div>';
                
                if (analysis.duplicates.length > 0) {
                    html += '<div class="stat-item">';
                    html += `<strong>üîÅ This series has been selected ${analysis.duplicates.length} time(s) before!</strong>`;
                    html += '</div>';
                    
                    analysis.duplicates.forEach((dup, index) => {
                        if (dup.allAboveAverage) {
                            html += '<div class="stat-item winning-series">';
                            html += '<strong>üåü REMARKABLE! This previously selected series has all 7 numbers above statistical average!</strong><br>';
                            html += `Main: ${dup.selection.main.join(', ')}<br>`;
                            html += `Bonus: ${dup.selection.bonus.join(', ')}`;
                            html += '</div>';
                        } else {
                            html += '<div class="stat-item">';
                            html += `Previous occurrence ${index + 1}: ${dup.aboveAverageCount} out of 7 numbers above average`;
                            html += '</div>';
                        }
                    });
                } else {
                    html += '<div class="stat-item">';
                    html += '<strong>This is a unique selection - never chosen before!</strong>';
                    html += '</div>';
                }
                
                html += '</div>';
                
                html += '<button class="toggle-stats-btn" onclick="app.toggleStatistics()">üìä View Detailed Statistics</button>';
                html += '<div id="statisticsSection" class="statistics-section hidden">';
                
                // Date filter section
                html += '<div class="filter-section">';
                html += '<h3>‚öôÔ∏è Filter Options</h3>';
                html += '<label>Include only selections from this date onward:</label>';
                html += '<input type="date" id="dateFilter" onchange="app.applyDateFilter()">';
                html += '<button class="btn" onclick="app.clearDateFilter()">Clear Date Filter</button>';
                if (this.filterDate) {
                    html += `<div class="filter-info">üìÖ Currently showing results from ${new Date(this.filterDate).toLocaleDateString()} onward</div>`;
                }
                html += '</div>';
                
                html += '<h3>üîÅ Combinations Selected More Than Once</h3>';
                if (analysis.duplicateCombos.length > 0) {
                    analysis.duplicateCombos.forEach(item => {
                        const highFreq = item.count >= 3;
                        html += `<div class="duplicate-combo ${highFreq ? 'high-frequency' : ''}">`;
                        html += `<span class="combo-numbers">${item.combo}</span>`;
                        html += `<span class="combo-count">${item.count}x</span>`;
                        html += '</div>';
                    });
                } else {
                    html += '<div class="stat-item">No combinations have been selected more than once yet.</div>';
                }
                
                html += '<h3>üìà Top 5 Most Selected Numbers (1-50)</h3>';
                html += '<div class="stats-grid">';
                analysis.topMainNumbers.forEach((item, index) => {
                    html += '<div class="stats-card">';
                    html += `<div class="number">#${index + 1}: ${item.number}</div>`;
                    html += `<div class="label">Frequency: ${item.frequency} times</div>`;
                    html += `<div class="deviation">${item.deviation >= 0 ? '+' : ''}${item.deviation.toFixed(1)}%</div>`;
                    html += '</div>';
                });
                html += '</div>';
                
                html += '<h3>üìâ Bottom 5 Least Selected Numbers (1-50)</h3>';
                html += '<div class="stats-grid">';
                analysis.bottomMainNumbers.forEach((item, index) => {
                    html += '<div class="stats-card">';
                    html += `<div class="number">#${index + 1}: ${item.number}</div>`;
                    html += `<div class="label">Frequency: ${item.frequency} times</div>`;
                    html += `<div class="deviation">${item.deviation >= 0 ? '+' : ''}${item.deviation.toFixed(1)}%</div>`;
                    html += '</div>';
                });
                html += '</div>';
                
                html += '<h3>üé≤ Top 2 Most Selected Bonus Numbers (1-12)</h3>';
                html += '<div class="stats-grid">';
                analysis.topBonusNumbers.forEach((item, index) => {
                    html += '<div class="stats-card">';
                    html += `<div class="number">#${index + 1}: ${item.number}</div>`;
                    html += `<div class="label">Frequency: ${item.frequency} times</div>`;
                    html += `<div class="deviation">${item.deviation >= 0 ? '+' : ''}${item.deviation.toFixed(1)}%</div>`;
                    html += '</div>';
                });
                html += '</div>';
                
                html += '<h3>üé≤ Bottom 2 Least Selected Bonus Numbers (1-12)</h3>';
                html += '<div class="stats-grid">';
                analysis.bottomBonusNumbers.forEach((item, index) => {
                    html += '<div class="stats-card">';
                    html += `<div class="number">#${index + 1}: ${item.number}</div>`;
                    html += `<div class="label">Frequency: ${item.frequency} times</div>`;
                    html += `<div class="deviation">${item.deviation >= 0 ? '+' : ''}${item.deviation.toFixed(1)}%</div>`;
                    html += '</div>';
                });
                html += '</div>';
                
                html += '</div>';
                
                content.innerHTML = html;
            },
            
            toggleStatistics() {
                const statsSection = document.getElementById('statisticsSection');
                const btn = document.querySelector('.toggle-stats-btn');
                
                if (statsSection.classList.contains('hidden')) {
                    statsSection.classList.remove('hidden');
                    btn.textContent = 'üìä Hide Detailed Statistics';
                } else {
                    statsSection.classList.add('hidden');
                    btn.textContent = 'üìä View Detailed Statistics';
                }
            },

            applyDateFilter() {
                const dateInput = document.getElementById('dateFilter');
                this.filterDate = dateInput.value;
                
                if (this.filterDate && this.analysisData && this.allIssues.length > 0) {
                    const newAnalysis = this.processAnalysis(this.allIssues);
                    this.analysisData = newAnalysis;
                    this.displayResults(newAnalysis);
                    
                    // Re-show statistics if they were already open
                    const statsSection = document.getElementById('statisticsSection');
                    if (!statsSection.classList.contains('hidden')) {
                        statsSection.classList.remove('hidden');
                        document.querySelector('.toggle-stats-btn').textContent = 'üìä Hide Detailed Statistics';
                    }
                }
            },

            clearDateFilter() {
                this.filterDate = null;
                const dateInput = document.getElementById('dateFilter');
                if (dateInput) {
                    dateInput.value = '';
                }
                
                if (this.analysisData && this.allIssues.length > 0) {
                    const newAnalysis = this.processAnalysis(this.allIssues);
                    this.analysisData = newAnalysis;
                    this.displayResults(newAnalysis);
                    
                    // Re-show statistics if they were already open
                    const statsSection = document.getElementById('statisticsSection');
                    if (!statsSection.classList.contains('hidden')) {
                        statsSection.classList.remove('hidden');
                        document.querySelector('.toggle-stats-btn').textContent = 'üìä Hide Detailed Statistics';
                    }
                }
            },

            reset() {
                document.getElementById('resultsSection').classList.add('hidden');
                document.getElementById('preparationSection').classList.add('hidden');
                document.getElementById('targetSection').classList.remove('hidden');
                this.gameState = {
                    selectedNumbers: [],
                    currentPool: [],
                    currentSelection: null,
                    selectionStep: 0,
                    usedImages: [],
                    poolType: 'main',
                    pendingGroups: null,
                    selectionSchedule: [],
                    currentScheduleIndex: 0
                };
                this.filterDate = null;
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
